<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Diagnostic MuseScore Web</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f9f9f9;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    h1, h3 {
      text-align: center;
      color: #333;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    textarea, select, button, input[type="file"] {
      width: 100%;
      padding: 0.8rem;
      margin-top: 0.5rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      margin-top: 1rem;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .response, .help, .history {
      margin-top: 2rem;
      padding: 1rem;
      background: #eef9ff;
      border-left: 5px solid #2196f3;
    }
    .history-entry {
      border-top: 1px solid #ccc;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Diagnostic MuseScore</h1>

    <label for="lancement">Le logiciel MuseScore :</label>
    <select id="lancement">
      <option value="">-- Choisissez --</option>
      <option value="demarrage">ne se lance pas</option>
      <option value="ouvert">est ouvert, mais jâ€™ai un bug ou une erreur</option>
    </select>

    <label for="os">SystÃ¨me dâ€™exploitation :</label>
    <select id="os">
      <option value="">-- Choisissez --</option>
      <option value="windows">Windows</option>
      <option value="macos">macOS</option>
      <option value="linux">Linux</option>
    </select>

    <label for="message">Message dâ€™erreur ou description du problÃ¨me :</label>
    <textarea id="message" rows="3" placeholder="DÃ©crivez ou collez le message d'erreur..."></textarea>

    <label for="image">ðŸ“¸ Ou envoyez une photo du message (OCR) :</label>
    <input type="file" id="image" accept="image/*">

    <button onclick="diagnostiquer()">Diagnostiquer</button>

    <div class="response" id="reponse" style="display:none;"></div>

    <div class="help">
      <h3>ðŸ“¦ Fichier de diagnostic MuseScore</h3>
      <p>Pour diagnostiquer un bug logiciel ou un plantage :</p>
      <ol>
        <li>Ouvrez MuseScore</li>
        <li>Allez dans <strong>Aide â†’ Diagnostic â†’ Enregistrer les fichiers de diagnostic</strong></li>
        <li>Un fichier <code>.zip</code> sera gÃ©nÃ©rÃ©, contenant logs, prÃ©fÃ©rences et plus</li>
        <li>Vous pouvez lâ€™analyser ou lâ€™envoyer Ã  un support</li>
      </ol>
    </div>

    <div class="history" id="historique">
      <h3>ðŸ•˜ Historique des diagnostics</h3>
      <div id="history-list"></div>
    </div>
  </div>

  <script>
    function diagnostiquer() {
      const lancement = document.getElementById('lancement').value;
      const os = document.getElementById('os').value;
      const message = document.getElementById('message').value.toLowerCase();
      const reponse = document.getElementById('reponse');
      let solution = "";

      if (!lancement || !os || !message.trim()) {
        alert("Merci de remplir tous les champs nÃ©cessaires.");
        return;
      }

      if (lancement === "demarrage") {
        solution = "MuseScore ne dÃ©marre pas : essayez de lancer le logiciel en ligne de commande avec l'option `-d` (mode debug) pour identifier l'erreur. Si cela Ã©choue, rÃ©installez MuseScore et videz vos prÃ©fÃ©rences.";
      } else if (message.includes("permission denied") && os === "macos") {
        solution = "Autorisez MuseScore dans PrÃ©fÃ©rences SystÃ¨me > SÃ©curitÃ© et confidentialitÃ© > AccÃ¨s complet au disque.";
      } else if (message.includes(".temp")) {
        solution = "Lâ€™erreur liÃ©e Ã  un fichier temporaire est souvent due Ã  un problÃ¨me de permission. Essayez dâ€™enregistrer la partition ailleurs, comme sur le Bureau.";
      } else if (message.includes("undefined") || message.includes("null")) {
        solution = "Bug interne de MuseScore. RedÃ©marrez le logiciel ou installez la derniÃ¨re version.";
      } else {
        solution = "Message non reconnu. Essayez dâ€™exporter les fichiers de diagnostic via Aide > Diagnostic.";
      }

      reponse.style.display = 'block';
      reponse.innerText = solution;
      sauvegarderHistorique(lancement, os, message, solution);
      afficherHistorique();
    }

    function sauvegarderHistorique(lancement, os, message, solution) {
      let historique = JSON.parse(localStorage.getItem("historique") || "[]");
      historique.unshift({ date: new Date().toLocaleString(), lancement, os, message, solution });
      localStorage.setItem("historique", JSON.stringify(historique.slice(0, 10))); // max 10 entrÃ©es
    }

    function afficherHistorique() {
      const historique = JSON.parse(localStorage.getItem("historique") || "[]");
      const container = document.getElementById("history-list");
      container.innerHTML = historique.map(e =>
        `<div class="history-entry">
          <strong>${e.date}</strong><br>
          OS: ${e.os} â€“ MuseScore: ${e.lancement}<br>
          Message: <em>${e.message}</em><br>
          âž¤ RÃ©ponse : ${e.solution}
        </div>`).join("");
    }

    // OCR
    document.getElementById('image').addEventListener('change', function () {
      const file = this.files[0];
      if (!file) return;
      Tesseract.recognize(file, 'eng+fra').then(({ data: { text } }) => {
        document.getElementById('message').value = text.trim();
      });
    });

    afficherHistorique();
  </script>
</body>
</html>
