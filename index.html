<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Diagnostic MuseScore</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2196f3" />
  <link rel="manifest" href="manifest.json" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 2rem;
      background: #f4f4f4;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    label {
      display: block;
      margin-top: 1rem;
    }
    textarea, select, input, button {
      width: 100%;
      padding: 0.8rem;
      margin-top: 0.5rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      margin-top: 1.5rem;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .response {
      margin-top: 2rem;
      padding: 1rem;
      background: #e9ffe9;
      border-left: 5px solid #28a745;
    }
    .historique {
      margin-top: 2rem;
      background: #fff;
      padding: 1rem;
      border: 1px solid #ccc;
    }
    .historique h3 {
      margin-top: 0;
    }
    .historique-entry {
      border-bottom: 1px dashed #ccc;
      padding: 0.5rem 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Diagnostic MuseScore</h1>

    <label for="message">Message d'erreur ou description du probl√®me :</label>
    <textarea id="message" rows="4" placeholder="Copiez ou d√©crivez le message d'erreur..."></textarea>

    <label for="os">Syst√®me d'exploitation :</label>
    <select id="os">
      <option value="">-- Choisissez --</option>
      <option value="windows">Windows</option>
      <option value="macos">macOS</option>
      <option value="linux">Linux</option>
    </select>

    <button onclick="diagnostiquer()">Diagnostiquer</button>

    <div class="response" id="reponse" style="display:none;"></div>

    <div class="historique" id="historique" style="display:none;">
      <h3>Historique des diagnostics</h3>
      <div id="listeHistorique"></div>
    </div>
  </div>

  <script>
    let erreurs = [];

    // Charger le fichier JSON
    fetch("assets/errors.json")
      .then(res => res.json())
      .then(data => {
        erreurs = data;
        console.log("‚úÖ Base d'erreurs charg√©e :", erreurs.length);
        afficherHistorique();
      });

    function diagnostiquer() {
      const message = document.getElementById('message').value.toLowerCase();
      const os = document.getElementById('os').value;
      const reponse = document.getElementById('reponse');
      const historique = document.getElementById('historique');

      let solution = "‚ùå Aucune correspondance trouv√©e. Veuillez affiner votre message ou consulter le support MuseScore.";
      let match = erreurs.find(e => {
        return e.match_keywords.some(m => message.includes(m)) &&
               (os === "" || e.labels.map(l => l.toLowerCase()).includes(os));
      });

      if (match) {
        solution = `‚úÖ Probl√®me identifi√© : ${match.title}\n\nüîó Voir : ${match.url}\n\nüí° Solution propos√©e :\n${match.solution || "(Aucune solution fournie encore)"}`;
      }

      reponse.style.display = 'block';
      reponse.innerText = solution;

      // Ajouter √† l'historique local
      const historiqueData = JSON.parse(localStorage.getItem("historique") || "[]");
      historiqueData.unshift({
        message, os, resultat: solution, date: new Date().toLocaleString()
      });
      localStorage.setItem("historique", JSON.stringify(historiqueData));
      afficherHistorique();
    }

    function afficherHistorique() {
      const data = JSON.parse(localStorage.getItem("historique") || "[]");
      const liste = document.getElementById("listeHistorique");
      const conteneur = document.getElementById("historique");
      if (data.length === 0) {
        conteneur.style.display = "none";
        return;
      }
      conteneur.style.display = "block";
      liste.innerHTML = data.slice(0, 5).map(entry => `
        <div class="historique-entry">
          <strong>${entry.date}</strong><br/>
          <em>Message:</em> ${entry.message}<br/>
          <em>OS:</em> ${entry.os || "non pr√©cis√©"}<br/>
          <em>R√©sultat:</em><br/>${entry.resultat.replace(/\n/g, "<br/>")}
        </div>
      `).join("");
    }
  </script>
</body>
</html>
